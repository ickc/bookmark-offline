SHELL := /bin/bash

## downloaded MD by Marky
# MD := $(wildcard data/offline/*.md)
## Convert all URL into URI
TXT := data/online.txt data/offline.txt
URI := $(patsubst %.txt,%.uri,$(TXT))

account: $(TXT)

# Initial Preparation #################################################

init: update marky.rb

# update submodule
update:
	git submodule update --recursive --remote
# prepare marky.rb from submodule
marky.rb: submodule/marky.rb
	rsync $< $@
	chmod +x $@

# Scripting ###########################################################

# Downloading: $(MD): use marky to download all links as markdown files
offline: data/notOffline.txt marky.rb
	mkdir -p data/offline
	< $< xargs -i -n1 -P128 ./marky.rb -o data/offline {}

# Accounting: obtain a list of downloaded URLs
data/offline.txt:
	find data/offline -iname '*.md' | xargs -i -n1 -P8 bash -c 'head -n 1 "$$0" | grep -oP "\[Source\]\(\K([^ ]*)"' {} | sort > $@

##########################################################################################################################

data/notOffline.txt: $(TXT)
	comm -23 $^ > $@

data/online.txt: # how to build online.txt? 2 different URL might as well point to the same site. Pocket, Instapaper, marky each could give a different URL for the same site. Requires some sort of "normalization" for *.list (from Pocket/Instapaper), offline.txt (from Marky)
